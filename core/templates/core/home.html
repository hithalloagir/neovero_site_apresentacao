{% extends "base.html" %}
{% load static %}

{% block title %}GC INFRA - Início{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <div class="row mb-4 align-items-end">
        <div class="col-md-8">
            <h2 class="fw-bold text-dark">Visão Geral <small class="text-muted fs-6 ms-2">Engenharia Clínica</small></h2>
            <p class="text-muted mb-0">
                {% if empresa_selecionada %}
                    Exibindo dados de: <strong>{{ empresa_selecionada }}</strong>
                {% else %}
                    Exibindo dados consolidados de <strong>todas as unidades</strong>.
                {% endif %}
            </p>
        </div>

        <div class="col-md-4">
            <form method="get" action="{% url 'home' %}">
                <label for="empresaSelect" class="form-label small fw-bold text-muted">Filtrar por Unidade:</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="bi bi-building"></i></span>
                    <select class="form-select" id="empresaSelect" name="empresa" onchange="this.form.submit()">
                        <option value="">Todas as Empresas</option>
                        {% for emp in empresas_disponiveis %}
                            <option value="{{ emp }}" {% if emp == empresa_selecionada %}selected{% endif %}>
                                {{ emp }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12 mt-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold text-danger">
                                <i class="bi bi-graph-up-arrow me-2"></i>Pendencias totais de metrologia atrasadas
                            </h6>
                            <small class="text-muted">Acúmulo mensal de Preventivas, Calibrações e TSE não realizadas.</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 350px;">
                            <canvas id="backlogChart"></canvas>
                        </div>
                        <div class="mt-3 text-center small text-muted">
                            <span class="me-3"><i class="bi bi-arrow-up-right text-danger"></i> Subindo: Acumulando problemas</span>
                            <span><i class="bi bi-arrow-down-right text-success"></i> Descendo: Resolvendo pendências</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12 mt-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold text-danger">
                                <i class="bi bi-graph-up-arrow me-2"></i>Pendencias de manutenção corretivas atrasadas
                            </h6>
                            <small class="text-muted">Acúmulo mensal de Corretivas não realizadas.</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 350px;">
                            <canvas id="backlogCorretivasChart"></canvas>
                        </div>
                        <div class="mt-3 text-center small text-muted">
                            <span class="me-3"><i class="bi bi-arrow-up-right text-danger"></i> Subindo: Acumulando problemas</span>
                            <span><i class="bi bi-arrow-down-right text-success"></i> Descendo: Resolvendo pendências</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12 mt-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold text-danger">
                                <i class="bi bi-graph-up-arrow me-2"></i>Total de serviços realizados
                            </h6>
                            <small class="text-muted">Acúmulo mensal de todos os serviços realizados.</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 350px;">
                            <canvas id="backlogTotalServicosChart"></canvas>
                        </div>
                        {% comment %} <div class="mt-3 text-center small text-muted">
                            <span class="me-3"><i class="bi bi-arrow-up-right text-danger"></i> Subindo: Acumulando serviços</span>
                            <span><i class="bi bi-arrow-down-right text-success"></i> Descendo: Resolvendo pendências</span>
                        </div> {% endcomment %}
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm border-start border-4 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase fw-bold mb-1" style="font-size: 0.8rem;">
                                    Quantidade de Equipamentos Médicos Cadastrados
                                </h6>
                                <h2 class="mb-0 fw-bold text-dark">
                                    {{ total_equipamentos_medicos }}
                                </h2>
                            </div>
                            <div class="icon-shape bg-primary bg-opacity-10 text-primary rounded-3 p-3">
                                <i class="bi bi-box-seam fs-4"></i>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block" style="font-size: 0.75rem;">
                            <i class="bi bi-check-circle-fill text-success me-1"></i> Cadastrados na base ativa
                        </small>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-0 shadow-sm border-start border-4 {% if kpi_disp_pct >= 98 %}border-success{% elif kpi_disp_pct >= 95 %}border-warning{% else %}border-danger{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase fw-bold mb-1" style="font-size: 0.8rem;">
                                    Disponibilidade de Equipamentos Médicos
                                </h6>
                                <h2 class="mb-0 fw-bold {% if kpi_disp_pct >= 98 %}text-success{% elif kpi_disp_pct >= 95 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ kpi_disp_pct }}%
                                </h2>
                            </div>
                            <div class="icon-shape {% if kpi_disp_pct >= 98 %}bg-success{% elif kpi_disp_pct >= 95 %}bg-warning{% else %}bg-danger{% endif %} bg-opacity-10 text-white rounded-3 p-3">
                                <i class="bi bi-activity fs-4 {% if kpi_disp_pct >= 98 %}text-success{% elif kpi_disp_pct >= 95 %}text-warning{% else %}text-danger{% endif %}"></i>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block" style="font-size: 0.75rem;">
                            <i class="bi bi-info-circle me-1"></i> {{ kpi_disp_qtd }} ativos de {{ kpi_disp_total }}
                        </small>
                    </div>
                </div>
            </div>

            <div class="container-fluid py-4">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h6 class="mb-0 fw-bold text-danger">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Detalhamento de Equipamentos Parados
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="myGrid" class="ag-theme-alpine" style="height: 400px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-0 shadow-sm border-start border-4 {% if qtd_criticos_parados > 0 %}border-danger{% else %}border-success{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase fw-bold mb-1" style="font-size: 0.8rem;">
                                    Críticos Parados
                                </h6>
                                <h2 class="mb-0 fw-bold {% if qtd_criticos_parados > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ qtd_criticos_parados }}
                                </h2>
                            </div>
                            <div class="icon-shape {% if qtd_criticos_parados > 0 %}bg-danger text-danger{% else %}bg-success text-success{% endif %} bg-opacity-10 rounded-3 p-3">
                                <i class="bi bi-exclamation-octagon-fill fs-4"></i>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block" style="font-size: 0.75rem;">
                            {% if qtd_criticos_parados > 0 %}
                                <i class="bi bi-arrow-up-circle text-danger me-1"></i> Equipamentos de alta prioridade fora de uso
                            {% else %}
                                <i class="bi bi-check-circle text-success me-1"></i> Nenhum crítico parado
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            <div class="container-fluid py-4">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h6 class="mb-0 fw-bold text-danger">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Detalhamento de Equipamentos Críticos Indisponíveis
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="myGridIndisponiveis" class="ag-theme-alpine" style="height: 400px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-0 shadow-sm border-start border-4 border-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase fw-bold mb-1" style="font-size: 0.8rem;">
                                    TMEF (MTBF) Geral
                                </h6>
                                <h2 class="mb-0 fw-bold text-dark">
                                    {{ kpi_mtbf }} <span class="fs-6 text-muted fw-normal">dias</span>
                                </h2>
                            </div>
                            <div class="icon-shape bg-info bg-opacity-10 text-info rounded-3 p-3">
                                <i class="bi bi-wrench-adjustable fs-4"></i>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block" style="font-size: 0.75rem;">
                            <i class="bi bi-calendar-check text-info me-1"></i> Referência: Ano Atual
                        </small>
                    </div>
                </div>
            </div>
        </div> 
    </div>
</div>

{{ labels_backlog|json_script:"backlog-labels" }}
{{ data_backlog|json_script:"backlog-data" }}

{{ labels_backlog_corretivas|json_script:"labels_backlog_corretivas" }}
{{ data_backlog_corretivas|json_script:"data_backlog_corretivas" }}

{{ labels_backlog_total_servicos|json_script:"labels_backlog_total_servicos" }}
{{ data_backlog_total_servicos|json_script:"data_backlog_total_servicos" }}

{{ lista_equipamentos_parados|json_script:"data-equipamentos-parados" }}

{{ lista_equipamentos_criticos_indisponiveis|json_script:"lista_equipamentos_criticos_indisponiveis" }}

<script src="{% static 'engenharia_clinica/js/eng_clinica_dashboard.js' %}"></script>

{% endblock %}