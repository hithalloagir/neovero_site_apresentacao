{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body p-3">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold text-muted small">Data Início</label>
                {{ form.data_inicio }}
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold text-muted small">Data Fim</label>
                {{ form.data_fim }}
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold text-muted small">Empresa</label>
                {{ form.empresa }}
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100 fw-bold">
                    <i class="bi bi-filter"></i> Filtrar
                </button>
            </div>
        </form>
    </div>
</div>

<div class="d-flex justify-content-end mb-3">
    <span class="badge bg-light text-muted border px-3 py-2 rounded-pill fw-normal">
        <i class="bi bi-calendar-range me-2"></i> Exibindo dados de <strong>{{ display_inicio }}</strong> até <strong>{{ display_fim }}</strong>
    </span>
</div>

<div class="row g-4 mb-4">
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <p class="text-uppercase text-muted fw-bold small mb-3">Tempo médio de atendimento por unidade(h)</p>
                <div style="height: 250px; position: relative;">
                    {% if labels_atendimento %}
                        <canvas id="chartAtendimentoMedio"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% comment %} <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <p class="text-uppercase text-muted fw-bold small mb-3">Tempo de Reparo x Tempo de Atendimento</p>
                <div style="height: 250px; position: relative;">
                    {% if dados_scatter %}
                        <canvas id="chartScatterReparo"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div> {% endcomment %}

    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <p class="text-uppercase text-muted fw-bold small mb-3">Tempo Médio de Reparo por Unidade (dia)</p>
                <div style="height: 250px; position: relative;">
                    {% if labels_reparo %}
                        <canvas id="chartReparoMedio"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h5 class="text-uppercase text-muted fw-bold small mb-3">Quantidade de OS por Tipo de Manutenção</h5>
                <div style="height: 400px; position: relative;">
                    {% if labels_tipo_manutencao_os %}
                        <canvas id="chartOsPorTipoManutencao"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <p class="text-uppercase text-muted fw-bold small mb-3">Taxa de cumprimento de prev, calib, quali e TSE (%)</p>
                <div style="height: 250px; position: relative;">
                    {% if labels_taxa_cumprimento_medio %}
                        <canvas id="chartCumprimentoPrev"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <p class="text-uppercase text-muted fw-bold small mb-3">Quantidade de OS planejadas já realizadas</p>
                <div style="height: 250px; position: relative;">
                    {% if labels_qtde_os_planejadas_realizadas %}
                        <canvas id="chartQtdeOSPlanejdasRealizadas"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <p class="text-uppercase text-muted fw-bold small mb-3">Quantidade de OS planejadas não fechadas</p>
                <div style="height: 250px; position: relative;">
                    {% if labels_qtde_os_planejadas_n_realizadas %}
                        <canvas id="chartQtdeOSPlanejdasNFechadas"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <p class="text-uppercase text-muted fw-bold small mb-3">Porcentagem de OS Planejadas Concluídas</p>
                <div style="height: 250px; position: relative;">
                    {% if labels_os_taxa_conclusao_planejamento %}
                        <canvas id="chartPorcentagemOSPlanejadasConcluidas"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <p class="text-uppercase text-muted fw-bold small mb-3">Taxa de Disponibilidade Geral dos Equipamentos</p>
                
                {% if labels_disponibilidade_equipamentos %}
                    <div class="row g-4 mb-4" id="chartTaxaDisponibilidadeEquipamentos">
                        </div>
                {% else %}
                    <div style="height: 200px;" class="d-flex flex-column align-items-center justify-content-center text-muted">
                        <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                        <small>Sem dados no período</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h5 class="text-uppercase fw-bold small mb-3 text-danger">
                    Taxa de Disponibilidade dos Equipamentos <span class="badge bg-danger">CRÍTICOS</span>
                </h5>
                {% if labels_taxa_disponibilidade_equipamentos_criticos %}
                    <div class="row g-4" id="rowDisponibilidadeEquipamentosCriticos">
                        </div>
                {% else %}
                    <div style="height: 200px;" class="d-flex flex-column align-items-center justify-content-center text-muted">
                        <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                        <small>Sem dados no período</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    {% comment %} <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h5 class="text-uppercase text-muted fw-bold small mb-3">Qtde de Equipamentos Cadastrados por Unidade</h5>
                <p class="text-muted small mb-2">Filtro por Data de Cadastro</p>
                <div style="height: 300px; position: relative;">
                    {% if labels_equipamentos_unidade %}
                        <canvas id="chartQTDEquipamentosUnidade"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div> {% endcomment %}

    <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h5 class="text-uppercase text-muted fw-bold small mb-3">Qtde de Equipamentos Críticos por Unidade</h5>
                <p class="text-muted small mb-2"><i class="bi bi-calendar-check"></i> Filtro: Data de Instalação</p>
                <div style="height: 300px; position: relative;">
                    {% if labels_equipamentos_criticos_por_unidade %}
                        <canvas id="chartEquipCriticosPorUnidade"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h5 class="text-uppercase text-muted fw-bold small mb-3">Tempo 1º Atendimento Equip. Crítico (h)</h5>
                <div style="height: 300px; position: relative;">
                    {% if labels_primeiro_atendimento_equipamento_critico %}
                        <canvas id="chartPrimeiroAtendimentoEquipCritico"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4"> 
    <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h5 class="text-uppercase text-muted fw-bold small mb-3">Idade Média dos Equipamentos por Unidade (Anos)</h5>
                <div style="height: 250px; position: relative;">
                    {% if labels_idade_equipamentos_unidade %}
                        <canvas id="chartIdadeMediaEquipamentosUnidade"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h5 class="text-uppercase text-muted fw-bold small mb-3">Idade dos Equipamentos por Família (Anos) - Top 20</h5>
                <div style="height: 350px; position: relative;">
                    {% if labels_idade_media_equipamentos_familia %}
                        <canvas id="chartIdadeFamiliaEquipamentos"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <h5 class="text-uppercase fw-bold small mb-0 text-danger">Maiores tempos de reparo de equipamentos críticos por família (h)</h5>
                    <span class="badge bg-danger ms-2">Corretiva + Alta Prioridade</span>
                </div>
                <div style="height: 350px; position: relative;">
                    {% if labels_reparo_tempo_critico %}
                        <canvas id="chartReparoCritico"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <h5 class="text-uppercase fw-bold small mb-0 text-danger">Principais Causas de Corretivas</h5>
                </div>
                <div style="height: 350px; position: relative;">
                    {% if labels_principais_causas_corretivas %}
                        <canvas id="chartCausasCorretivas"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <h5 class="text-uppercase fw-bold small mb-0 text-danger">Maiores tempos de PARADA de equipamentos críticos por família (h)</h5>
                    <span class="badge bg-danger ms-2">Downtime Real</span>
                </div>
                <div style="height: 350px; position: relative;">
                    {% if labels_maiores_tempos_parada_criticos_por_familia %}
                        <canvas id="elchartParadaCritica"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h5 class="text-uppercase text-muted fw-bold small mb-3">Tempo MEDIANO de Parada de Críticos por Unidade (h)</h5>
                <div style="height: 300px; position: relative;">
                    {% if labels_tempo_mediano_parada_criticos_por_unidade %}
                        <canvas id="chartMedianaParadaEquipamentosCriticosUnidade"></canvas>
                    {% else %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-inbox fs-1 mb-2 opacity-50"></i>
                            <small>Sem dados no período</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <h5 class="text-uppercase text-muted fw-bold small mb-0">Horários em que equipamentos críticos ficaram indisponíveis</h5>
                    <span class="badge bg-danger ms-2">Mapa de Calor (Qtd OS)</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-sm text-center small align-middle" id="heatmapTable">
                        <thead>
                            <tr class="table-light">
                                <th style="width: 80px;">Hora</th>
                                {% for dia in pivot_indisponibilidade_equipamentos_criticos.dias %}
                                    <th>{{ dia }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for linha in pivot_indisponibilidade_equipamentos_criticos.matriz %}
                        <tr>
                            <td class="fw-bold text-muted bg-light">{{ linha.hora }}</td>
                            
                            {% for celula in linha.celulas %}
                                <td class="heatmap-cell" 
                                    data-value="{{ celula.valor }}"
                                    data-bs-toggle="tooltip" 
                                    data-bs-html="true" 
                                    title="{{ celula.tooltip }}">
                                    
                                    {% if celula.valor > 0 %}
                                        {{ celula.valor }}
                                    {% else %}
                                        <span class="text-muted fw-light text-opacity-25" style="font-size: 0.8em;">-</span>
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-end mt-2 small text-muted">
                    <div class="me-3"><span style="display:inline-block;width:12px;height:12px;background-color:#fff;border:1px solid #dee2e6;"></span> 0</div>
                    <div class="me-3"><span style="display:inline-block;width:12px;height:12px;background-color:#ffebcc;"></span> Baixo</div>
                    <div class="me-3"><span style="display:inline-block;width:12px;height:12px;background-color:#fd7e14;"></span> Médio</div>
                    <div><span style="display:inline-block;width:12px;height:12px;background-color:#dc3545;"></span> Alto</div>
                </div>

            </div>
        </div>
    </div>
</div>


{{ labels_atendimento|json_script:"labels_atendimento" }}
{{ data_atendimento|json_script:"data_atendimento" }}

{{ dados_scatter|json_script:"dados_scatter" }}

{{ labels_reparo|json_script:"labels_reparo" }}
{{ data_reparo|json_script:"data_reparo" }}

{{ labels_taxa_cumprimento_medio|json_script:"labels_taxa_cumprimento_medio" }}
{{ data_taxa_cumprimento_medio|json_script:"data_taxa_cumprimento_medio" }}
{{ taxa_cumprimento_metadados|json_script:"taxa_cumprimento_metadados" }}

{{ labels_tipo_manutencao_os|json_script:"labels_tipo_manutencao_os" }}
{{ data_tipo_manutencao_os|json_script:"data_tipo_manutencao_os" }}

{{ labels_qtde_os_planejadas_realizadas|json_script:"labels_qtde_os_planejadas_realizadas" }}
{{ data_qtde_os_planejadas_realizadas|json_script:"data_qtde_os_planejadas_realizadas" }}

{{ labels_qtde_os_planejadas_n_realizadas|json_script:"labels_qtde_os_planejadas_n_realizadas" }}
{{ data_qtde_os_planejadas_n_realizadas|json_script:"data_qtde_os_planejadas_n_realizadas" }}


{{ labels_os_taxa_conclusao_planejamento|json_script:"labels_os_taxa_conclusao_planejamento" }}
{{ data_os_taxa_conclusao_planejamento|json_script:"data_os_taxa_conclusao_planejamento" }}
{{ plan_taxa_metadados|json_script:"plan_taxa_metadados" }}

{{ labels_disponibilidade_equipamentos|json_script:"labels_disponibilidade_equipamentos" }}
{{ data_disponibilidade_equipamentos|json_script:"data_disponibilidade_equipamentos" }}

{{ labels_equipamentos_unidade|json_script:"labels_equipamentos_unidade" }}
{{ data_equipamentos_unidade|json_script:"data_equipamentos_unidade" }}

{{ labels_idade_equipamentos_unidade|json_script:"labels_idade_equipamentos_unidade"}}
{{ data_idade_equipamentos_unidade|json_script:"data_idade_equipamentos_unidade"}}

{{ labels_idade_media_equipamentos_familia|json_script:"labels_idade_media_equipamentos_familia"}}
{{ data_idade_media_equipamentos_familia|json_script:"data_idade_media_equipamentos_familia"}}

{{ labels_reparo_tempo_critico|json_script:"labels_reparo_tempo_critico" }}
{{ data_reparo_tempo_critico|json_script:"data_reparo_tempo_critico" }}

{{ labels_principais_causas_corretivas|json_script:"labels_principais_causas_corretivas" }}
{{ data_principais_causas_corretivas|json_script:"data_principais_causas_corretivas" }}

{{ labels_maiores_tempos_parada_criticos_por_familia|json_script:"labels_maiores_tempos_parada_criticos_por_familia" }}
{{ data_maiores_tempos_parada_criticos_por_familia|json_script:"data_maiores_tempos_parada_criticos_por_familia" }}

{{ labels_tempo_mediano_parada_criticos_por_unidade|json_script:"labels_tempo_mediano_parada_criticos_por_unidade" }}
{{ data_tempo_mediano_parada_criticos_por_unidade|json_script:"data_tempo_mediano_parada_criticos_por_unidade" }}

{{ labels_taxa_disponibilidade_equipamentos_criticos|json_script:"labels_taxa_disponibilidade_equipamentos_criticos" }}
{{ data_taxa_disponibilidade_equipamentos_criticos|json_script:"data_taxa_disponibilidade_equipamentos_criticos" }}

{{ labels_equipamentos_criticos_por_unidade|json_script:"labels_equipamentos_criticos_por_unidade" }}
{{ data_equipamentos_criticos_por_unidade|json_script:"data_equipamentos_criticos_por_unidade" }}

{{ labels_primeiro_atendimento_equipamento_critico|json_script:"labels_primeiro_atendimento_equipamento_critico" }}
{{ data_primeiro_atendimento_equipamento_critico|json_script:"data_primeiro_atendimento_equipamento_critico" }}

<script src="{% static 'engenharia/js/dashboard_graficos_charts.js' %}"></script>
{% endblock %}